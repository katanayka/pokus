name: ci
on:
  push:
    branches: [main]
  pull_request: {}
jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          POSTGRES_DB: app
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U app"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    env:
      DJANGO_SECRET_KEY: test-secret
      DEBUG: "false"
      ALLOWED_HOSTS: "localhost,127.0.0.1"
      POSTGRES_DB: app
      POSTGRES_USER: app
      POSTGRES_PASSWORD: app
      POSTGRES_HOST: 127.0.0.1
      POSTGRES_PORT: "5432"
      NOTIFY_URL: http://localhost:8081
      NOTIFY_TOKEN: notify-secret
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Django tests
        run: python manage.py test
      - name: Setup go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Go tests
        run: cd notification && go test ./...
      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Frontend tests
        run: |
          cd frontend
          npm ci
          npm test
  build:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - name: Build images
        run: |
          docker build -t app-backend -f Dockerfile.django .
          docker build -t app-notify -f notification/Dockerfile notification
  push:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push images
        run: |
          DJANGO_IMAGE=ghcr.io/${{ github.repository }}-django:${{ github.sha }}
          NOTIFY_IMAGE=ghcr.io/${{ github.repository }}-notify:${{ github.sha }}
          docker build -t $DJANGO_IMAGE -f Dockerfile.django .
          docker build -t $NOTIFY_IMAGE -f notification/Dockerfile notification
          docker push $DJANGO_IMAGE
          docker push $NOTIFY_IMAGE
          docker tag $DJANGO_IMAGE ghcr.io/${{ github.repository }}-django:latest
          docker tag $NOTIFY_IMAGE ghcr.io/${{ github.repository }}-notify:latest
          docker push ghcr.io/${{ github.repository }}-django:latest
          docker push ghcr.io/${{ github.repository }}-notify:latest
  deploy:
    runs-on: ubuntu-latest
    needs: push
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      packages: read
    steps:
      - uses: actions/checkout@v4
      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Deploy (docker compose)
        env:
          DJANGO_IMAGE: ghcr.io/${{ github.repository }}-django:${{ github.sha }}
          NOTIFY_IMAGE: ghcr.io/${{ github.repository }}-notify:${{ github.sha }}
          DJANGO_SECRET_KEY: test-secret
          DEBUG: "false"
          ALLOWED_HOSTS: "localhost,127.0.0.1"
          POSTGRES_DB: app
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
          NOTIFY_TOKEN: notify-secret
        run: |
          docker compose -f deploy/docker-compose.prod.yml up -d
          docker compose -f deploy/docker-compose.prod.yml ps
